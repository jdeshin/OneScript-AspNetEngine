# SqlDataProcessor

Библиотека, реализующая работу с СУБД в http-сервисах OneScript как с набором обработок.
Библиотека создана на основе библиотеки (oscript-sql)[https://github.com/ret-Phoenix/oscript-sql] и фактически использует ее слегка модифицированный вариант для реализации возможности работы с библиотекой как с набором обработок.
Модифицированная библиотека oscript-sql является временным решением до выхода обновлений основной библиотеки.

## Установка

### Предварительные условия

Web-приложение должно использовать ASPNETHandler версии не ниже 1.2 (релиз библиотек >= 1.3.0). Также должна быть установлена библиотека DataProcessors.

### Модифицированная библиотека oscript-sql

Установка осуществляется копированием с заменой, файлов dll в папку Bin web-приложения.
Если библиотека не использовалась ранее, необходимо подключить библиотеку, добавив нижеследующую строку в секцию ```<appSettings>```, файла web.config:

```bsl
<add key="sql" value="attachAssembly" />
```

### Библиотека SqlDataProcessor

Для установки библиотеки необходимо выполнить нижеследующие действия:

1. Скопировать файл __SqlDataProcessor.dll__ в папку Bin web-приложения.

2. Подключить библиотеку, добавив нижеследующую строку в секцию ```<appSettings>```, файла web.config:

```bsl
<add key="SqlDataProcessor" value="attachAssembly" />
```

3. Подключить классы как обработки,  добавив нижеследующую строку в секцию ```<appSettings>```, файла web.config:

 ```bsl
<add key="attachAsDataProcessor;SqlDataProcessor;OneScript.SqlDataProcessor.DBConnector" value="" />
<add key="attachAsDataProcessor;SqlDataProcessor;OneScript.SqlDataProcessor.DBQuery" value="" />
<add key="attachAsDataProcessor;SqlDataProcessor;OneScript.SqlDataProcessor.DBConnectionProperties" value="" />
 ```

## Описание

Библиотека реализует подмножество функций библиотеки oscript-sql в виде набора обработок. 

### Обработки.СоединениеСУБД

Методы:

- ТипыСУБД() - Возвращает доступные типы СУБД. Функция возвращает экземпляр типа __ТипСУБД__, исходной библиотеки.
- Создать() - Создает экземпляр объекта-обработки типа __Соединение__, исходной библиотеки.

### Обработки.ЗапросСУБД

Методы:

- Создать() - Создает экземпляр объекта-обработки типа __Запрос__, исходной библиотеки.

### Обработки.ПараметрыСоединенияСУБД

Методы:

- Создать() - Создает экземпляр объекта-обработки типа __ПараметрыСоединенияСУБДМодульОбъекта__. 
- ПолучитьСтрокуСоединения(ИмяСоединения) - Возвращает строку соединения из файла web.config, соответствующую соединению с именем ИмяСоединения. Параметр ИмяСоединения имеет тип __Строка__.
- ПолучитьТипСУБД(ИмяСоединения) - Возвращает тип СУБД из файла web.config, соответствующий соединению с именем ИмяСоединения. Параметр ИмяСоединение имеет тип __Строка__.

Строка соединения находится в секции ```<connectionstrings>```, файла web.ini и имеет примерно следующий вид (конкретный вид строки зависит от используемой СУБД):

```bsl
    <connectionStrings>
        <add name="ConnStr" connectionString="Data Source=ПутьКФайлуБД\ИмяФайлаБД;PRAGMA journal_mode=WAL;PRAGMA foreign_keys = ON;Version=3;" />
    </connectionStrings>

```

Информация о типе СУБД находится в секции ```<appSettings>```, файла web.ini и имеет примерно следующий вид:

```bsl
<add key="ConnStr" value="SQLite" />
```

### ПараметрыСоединенияСУБДМодульОбъекта

Данный тип не содержит каких-либо методов или свойств.

## Использование

```bsl
// Соединение
Соединение = Обработки.СоединениеСУБД.Создать();
Соединение.СтрокаСоединения = Обработки.ПараметрыСоединенияСУБД.ПолучитьСтрокуСоединения("ConnStr");
Соединение.ТипСУБД = Обработки.ПараметрыСоединенияСУБД.ПолучитьТипСУБД("ConnStr");

Соединение.Открыть();

// Имя переменной: Идентификатор
// Имя параметра: id
// 
Идентификатор = 3;

Запрос = Соединение.СоздатьЗапрос();
Запрос.Текст = "
| select * from product
| where id = @id
|";

Запрос.УстановитьПараметр("id", Идентификатор);

Результаты = Запрос.ВыполнитьЗапрос().Выгрузить();
Соединение.Закрыть();
```
